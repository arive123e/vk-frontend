<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VK ID Callback</title>
  <script src="https://unpkg.com/@vkid/sdk@2.5.2/dist-sdk/umd/index.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 40px; }
    .center { max-width: 400px; margin: 40px auto; text-align: center; }
    .error { color: #c00; margin-top: 20px; }
    .success { color: #093; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="center">
    <h2>–ó–∞–≤–µ—Ä—à–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é VK ID...</h2>
    <div id="result"></div>
  </div>
 <script>
function showMsg(msg, ok) {
  document.getElementById('result').innerHTML = `<div class="${ok ? 'success' : 'error'}">${msg}</div>`;
}

if ('VKIDSDK' in window) {
  window.VKIDSDK.Callback.process()
    .then(async ({ code, device_id, state, code_verifier }) => {
      // –ü–∏—à–µ–º –≤—Å—ë –≤ –∫–æ–Ω—Å–æ–ª—å!
      console.log('VKID CALLBACK:', { code, device_id, state, code_verifier });

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏
      showMsg('DEBUG: ' + JSON.stringify({ code, device_id, state, code_verifier }), true);

      try {
        const res = await fetch('/auth/vk/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            code,
            device_id,
            code_verifier,
            tg_id: state
          })
        });
        const data = await res.json();
        if (data.success) {
          showMsg('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ú–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ Telegram ü§ó', true);
        } else {
          showMsg('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), false);
        }
      } catch (err) {
        showMsg('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + err.message, false);
      }
    })
    .catch(err => {
      showMsg('VKID CALLBACK ERROR: ' + err.message, false);
      console.error(err);
    });
} else {
  document.body.innerHTML += "<div style='color:#c00;'>–û—à–∏–±–∫–∞ VKID SDK!</div>";
}
</script>
</body>
</html>
