<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Фокусник Альтаир — Авторизация через VK ID</title>
  <!-- VK ID SDK -->
  <script src="https://unpkg.com/@vkid/sdk@2.5.2/dist-sdk/umd/index.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 40px; }
    .wrap { max-width: 400px; margin: 0 auto; }
    h1 { font-size: 2em; margin-bottom: 0.5em; }
    #VkIdSdkOneTap { margin-top: 20px; }
    .error { color: #c00; margin-top: 30px; }
    .success { color: #0a0; margin-top: 30px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Фокусник Альтаир</h1>
    <p>Для доступа к сервису авторизуйтесь через VK ID:</p>
    <div id="VkIdSdkOneTap"></div>
    <div id="error" class="error"></div>
    <div id="success" class="success"></div>
  </div>
  <script>
    // ====== VK ID + PKCE (OneTap) ======

    // Генерация PKCE code_verifier (64 символа, рекомендовано VK)
    function generateCodeVerifier() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_-';
      let arr = Array.from(crypto.getRandomValues(new Uint8Array(64)));
      return arr.map(x => chars[x % chars.length]).join('');
    }

    // Генерация PKCE code_challenge (SHA-256 + base64url)
    async function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const hash = await window.crypto.subtle.digest('SHA-256', data);
      let base64 = btoa(String.fromCharCode(...new Uint8Array(hash)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      return base64;
    }

    // Получение Telegram ID из query (?tg_id=...)
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const tg_id = getQueryParam('tg_id');
    if (!tg_id) {
      document.getElementById('error').textContent = 'Ошибка: Telegram ID не передан! Пожалуйста, перейдите по правильной ссылке из Telegram-бота.';
      throw new Error('tg_id обязателен');
    }

    (async () => {
      // 1. Генерируем PKCE параметры
      const code_verifier = generateCodeVerifier();
      const code_challenge = await generateCodeChallenge(code_verifier);

      // 2. Проверяем, что SDK загрузился
      if (!('VKIDSDK' in window)) {
        document.getElementById('error').textContent = 'Ошибка загрузки VKID SDK!';
        return;
      }
      const VKID = window.VKIDSDK;

      // 3. Инициализируем VKID SDK OneTap с PKCE
      VKID.Config.init({
        app: 53336238, // Твой client_id
        redirectUrl: 'https://api.fokusnikaltair.xyz/auth/vk/callback', // Совпадает с настройками VK!
        state: tg_id, // Телеграм ID как state
        scope: 'groups',
        pkce: {
          codeChallenge: code_challenge,
          codeChallengeMethod: 'S256'
        }
      });

      const oneTap = new VKID.OneTap();

      // 4. Обработка успешной авторизации
      oneTap
        .on(window.VKIDSDK.OneTapInternalEvents.LOGIN_SUCCESS, async ({ code, device_id, state }) => {
          try {
            // Отправляем параметры на backend для обмена на токен
            const res = await fetch('/auth/vk/token', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                code,
                code_verifier, // тот же, что был сгенерирован выше
                device_id,
                tg_id: state // Telegram ID (state)
              })
            });
            const result = await res.json();
            if (result.success) {
              document.getElementById('success').textContent = 'Успешная авторизация! Можете вернуться в Telegram.';
            } else {
              document.getElementById('error').textContent = result.error || 'Не удалось авторизоваться.';
            }
          } catch (err) {
            document.getElementById('error').textContent = 'Ошибка обмена кода на токен: ' + err.message;
          }
        })
        .on(window.VKIDSDK.WidgetEvents.ERROR, (err) => {
          document.getElementById('error').textContent = 'Ошибка VK ID: ' + (err.message || err);
        });

      oneTap.render({ container: document.getElementById('VkIdSdkOneTap') });
    })();
  </script>
</body>
</html>
