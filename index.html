<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–∞–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç–∞–ª –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ VK ID</title>
    <script src="https://unpkg.com/@vkid/sdk@2.5.2/dist-sdk/umd/index.js"></script>
</head>
<body>
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
     <!-- üîπ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è VK SDK –∫–Ω–æ–ø–∫–∏ -->
  <div id="vkid_container"></div>
    
    <script>
        setTimeout(function () {
            if ('VKIDSDK' in window) {
                const VKID = window.VKIDSDK;

                // –ü–æ–ª—É—á–µ–Ω–∏–µ tg_id –∏–∑ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                function getTelegramId() {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get('tg_id') || '';
                }
                const tg_id = getTelegramId();
                
                // === üîç –î–û–ë–ê–í–õ–ï–ù–ù–´–ï –õ–û–ì–ò –î–õ–Ø –ü–†–û–í–ï–†–ö–ò ===
                console.log("üü¢ VKID redirectUrl:", 'https://api.fokusnikaltair.xyz/auth/vk/callback');
                console.log("üü¢ VKID state (tg_id):", tg_id);

                // === –î–û–ë–ê–í–õ–Ø–ï–ú PKCE –Ø–í–ù–û! ===
                VKID.Config.init({
                    app: 53336238,
                    redirectUrl: 'https://api.fokusnikaltair.xyz/auth/vk/callback',
                    responseMode: VKID.ConfigResponseMode.Callback,
                    source: VKID.ConfigSource.LOWCODE,
                    scope: 'friends,groups,wall,docs,photos,video,email,offline',
                    state: tg_id,
                    usePkce: true // <<< üî• –í–ê–ñ–ù–û: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è PKCE!
                });

                // –ü–µ—Ä–µ—Ö–≤–∞—Ç —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ ‚Äî –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ–∑–∂–µ)
                VKID.Events.subscribe(VKID.Events.CODE_RECEIVED, (event) => {
                    // –í event.codeVerifier —Ö—Ä–∞–Ω–∏—Ç—Å—è code_verifier –¥–ª—è PKCE
                    if (event && event.codeVerifier) {
                        sessionStorage.setItem('vk_code_verifier', event.codeVerifier);
                        console.log('PKCE code_verifier —Å–æ—Ö—Ä–∞–Ω—ë–Ω:', event.codeVerifier);
                    }
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–º code
                    console.log('VKID code:', event.code);
                });
                
                const oneTap = new VKID.OneTap();

                oneTap.render({
                    container: document.getElementById('vkid_container'),
                    showAlternativeLogin: true
                })
                .on(VKID.WidgetEvents.ERROR, vkidOnError);

                function vkidOnError(error) {
                    // –ü–æ–∫–∞–∂–∏ –æ—à–∏–±–∫—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ –∏–ª–∏ —Å–¥–µ–ª–∞–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error?.message || error);
                }
            } else {
                console.error('VKID SDK –ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω! –í–∏–¥–∂–µ—Ç –Ω–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω.');
            }
        }, 2000); // –ñ—ë—Å—Ç–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ SDK
    </script>
</body>
</html>
